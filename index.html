<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, user-scalable=no">
  <title>Stickman Fighter</title>
  <style>
    body {
      margin: 0;
      background: #111;
      color: white;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      touch-action: manipulation;
    }
    canvas {
      background: #222;
      margin-top: 10px;
      border: 2px solid #444;
      touch-action: none;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin: 10px;
    }
    .button {
      width: 70px;
      height: 70px;
      margin: 5px;
      font-size: 18px;
      border-radius: 10px;
      border: none;
      background: #444;
      color: white;
      touch-action: manipulation;
    }
    .button:active {
      background: #666;
    }
  </style>
</head>
<body>

<canvas id="gameCanvas" width="360" height="480"></canvas>

<div class="controls">
  <button class="button" id="left">‚óÄÔ∏è</button>
  <button class="button" id="right">‚ñ∂Ô∏è</button>
  <button class="button" id="up">‚¨ÜÔ∏è</button>
  <button class="button" id="kick">ü¶µ</button>
  <button class="button" id="punch">üëä</button>
</div>

<script>
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");

  const socket = new WebSocket("wss://stick-man-fighter.glitch.me");

  let playerId = null;
  let myPlayer = { x: 100, y: 400, vx: 0, punching: false, kicking: false };
  let otherPlayers = {};

  const speed = 3;

  socket.onmessage = (event) => {
    const data = JSON.parse(event.data);

    if (data.type === "init") {
      playerId = data.playerId;
    } else if (data.type === "position" && data.id !== playerId) {
      otherPlayers[data.id] = data;
    } else if (data.type === "remove") {
      delete otherPlayers[data.id];
    }
  };

  function sendPosition() {
    if (playerId) {
      socket.send(JSON.stringify({
        type: "position",
        id: playerId,
        x: myPlayer.x,
        y: myPlayer.y,
        punching: myPlayer.punching,
        kicking: myPlayer.kicking
      }));
    }
  }

  function drawStickman(player, color) {
    const { x, y, punching, kicking } = player;
    ctx.strokeStyle = color;
    ctx.lineWidth = 3;

    ctx.beginPath();
    ctx.arc(x, y - 40, 10, 0, Math.PI * 2); // Head
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(x, y - 30);
    ctx.lineTo(x, y - 10); // Body
    ctx.stroke();

    // Arms
    ctx.beginPath();
    ctx.moveTo(x, y - 25);
    ctx.lineTo(x + (punching ? 15 : 10), y - 20);
    ctx.moveTo(x, y - 25);
    ctx.lineTo(x - 10, y - 20);
    ctx.stroke();

    // Legs
    ctx.beginPath();
    ctx.moveTo(x, y - 10);
    ctx.lineTo(x + (kicking ? 15 : 10), y + 10);
    ctx.moveTo(x, y - 10);
    ctx.lineTo(x - 10, y + 10);
    ctx.stroke();
  }

  function detectHit(playerA, playerB) {
    const dx = playerA.x - playerB.x;
    const dy = playerA.y - playerB.y;
    return Math.abs(dx) < 20 && Math.abs(dy) < 40;
  }

  function gameLoop() {
    myPlayer.x += myPlayer.vx;
    myPlayer.x = Math.max(10, Math.min(canvas.width - 10, myPlayer.x));

    sendPosition();

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#333";
    ctx.fillRect(0, 410, canvas.width, 5);

    drawStickman(myPlayer, "lime");
    for (let id in otherPlayers) {
      const p = otherPlayers[id];
      drawStickman(p, "red");

      if ((myPlayer.punching || myPlayer.kicking) && detectHit(myPlayer, p)) {
        console.log("HIT!");
      }
    }

    requestAnimationFrame(gameLoop);
  }

  gameLoop();

  let moveLeft = false;
  let moveRight = false;

  function updateMovement() {
    myPlayer.vx = moveLeft ? -speed : moveRight ? speed : 0;
  }

  document.getElementById("left").addEventListener("touchstart", () => {
    moveLeft = true;
    updateMovement();
  });
  document.getElementById("left").addEventListener("touchend", () => {
    moveLeft = false;
    updateMovement();
  });

  document.getElementById("right").addEventListener("touchstart", () => {
    moveRight = true;
    updateMovement();
  });
  document.getElementById("right").addEventListener("touchend", () => {
    moveRight = false;
    updateMovement();
  });

  document.getElementById("up").addEventListener("touchstart", () => {
    myPlayer.y -= 40;
    setTimeout(() => myPlayer.y += 40, 300);
  });

  document.getElementById("kick").addEventListener("touchstart", () => {
    myPlayer.kicking = true;
    sendPosition();
    setTimeout(() => {
      myPlayer.kicking = false;
      sendPosition();
    }, 300);
  });

  document.getElementById("punch").addEventListener("touchstart", () => {
    myPlayer.punching = true;
    sendPosition();
    setTimeout(() => {
      myPlayer.punching = false;
      sendPosition();
    }, 300);
  });

  document.addEventListener("touchstart", (e) => {
    if (e.touches.length > 1) e.preventDefault();
  }, { passive: false });

  let lastTouchEnd = 0;
  document.addEventListener("touchend", (e) => {
    const now = new Date().getTime();
    if (now - lastTouchEnd <= 300) e.preventDefault();
    lastTouchEnd = now;
  }, false);
</script>

</body>
</html>
